大纲
====
	1.什么是ansible
	2.ansible特性/优点
	3.ansible基础架构
	4.ansible安装与配置
	5.ansible inventory
	6.ansible ad-hoc
	7.ansible playbook
	8.变量 variables （优先级）
	9.判断和循环语句
	10.异常处理
	11.tag 标签
	12.handlers 触发器
	13.include 包含
	14.ansible jinja 模板
	15.ansible role 角色
	16.ansible galaxy
	17.ansible tower

### 一、什么是ansible
IT自动化的配置管理工具，主要体现在ansible集成了丰富的模块和功能组件。减少重复性工作和维护成本。

### 二、ansible特性/优点
	1.特性
		a. 批量执行远程命令
		b. 批量配置软件服务
		c. 实现软件开发功能
		d. 编排高级的IT任务
	2.优点
		a. 无代理模式
		b. 操作灵活，简单易用
		c. 安全，使用ssh协议进行通讯
		d. 可移植性高

### 三、ansible基础架构
	主机清单：inventory（对不同的主机进行逻辑上的分组）
				host：单个主机
				group：多个主机
	AD-Hoc：单条命令，通过不同的python module实现不同的操作
	Playbook：YAML语言编写，将多个AD-Hoc命令集中到一个文件中执行
	tcp/ssh：控制端与被控端之间的命令推送需要保证传输安全可靠

### 四、ansible的安装与配置
主要的重点在于配置文件的所在路径
#### 安装
```shell
Centos && Redhat
# yum install ansible -y
	#需要注意的是，Centos或RHEL安装ansible时需要EPEL源，可参考下面的链接

Ubuntu
$ sudo apt-get install -y ansible
```
[7版本的EPEL源](https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm) <br />
[8版本的EPEL源](https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm)
#### 配置
```shell
$ ansible --version
ansible 2.9.6
  config file = /etc/ansible/ansible.cfg
  configured module search path = ['/home/hebo/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python3/dist-packages/ansible
  executable location = /usr/bin/ansible
  python version = 3.8.2 (default, Jul 16 2020, 14:00:26) [GCC 9.3.0]
```
配置文件|作用
:-:|:-:
config file|ansible的主配置文件的路径
configured module|ansible模块查找路径
ansible python|ansible模块在python中的路径
executable location|ansible命令执行路径
host_key_checking|检查ssh认证，默认情况被注释
timeout|超时时间，主机较多时可适当延长超时时间
```diff
- 需要注意的是，config file的位置是有优先级的，配置文件的路径的不同导致优先级的不同，优先级高的路径优先被读取。
- 如果有多个config file，则优先级高的config file生效。优先级从高到低如下：
	ANSIBLE_CONFIG（变量指定配置文件）
	ansible.cfg（当前目录下）
	.ansible.cfg（当前用户的家目录下）
	/etc/ansible/ansible.cfg
```
实际上，ansible.cfg中没有多少需要更改的配置，下面是一些常用配置选项的作用
选项|作用
:-:|:-:
inventory|指令hosts文件默认所在位置，可认为修改
forks|并发数，ansible默认一次推送命令到5台主机
remote_tmp|客户端执行ansible推送的命令时，需要通过python解析，解析时需要一个缓存目录，此选项指定缓存目录的位置
remote_port|远程端口

### 五、Ansible Inventory
Inventory文件中写入了被管理主机与主机组信息。默认文件路径位于/etc/ansible/hosts。可通过 -i 选项指定Inventory文件位置。连接被管理主机的方式有多种，但此处仅强调基于密钥连接

#### 基于密码
```shell
$ cat hosts

#主机+端口+密码
[webservers]
10.250.1.51 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass='redhat'
10.250.1.52 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass='redhat'

#域名+密码
[webservers]
web[1:2].example.com ansible_ssh_pass='redhat'

#域名+密码，此处为webservers设置vars变量
[webservers]
web[1:2].example.com
[webservers:vars]
ansible_ssh_pass='redhat'
```

#### 基于密钥
```shell
# ssh-keygen	#密钥操作自行百度
# ssh-copy-id -i ~/.ssh/id_rsa.pub 10.250.1.51
# ssh-copy-id -i ~/.ssh/id_rsa.pub 10.250.1.52
# cat hosts
[webservers]
10.250.1.51
10.250.1.52

#别名+地址+端口
[webservers]
web1 ansible_ssh_host=10.250.1.51 ansible_ssh_port=22
web2 ansible_ssh_host=10.250.1.52
```
	#注：若当前下发公钥的用户不是root，则需要在目标主机地址前面指定root账户

#### 主机组
```shell
# cat hosts
[lbservers]
10.250.1.51
10.250.1.52

[webservers]
10.250.1.53
10.250.1.54

[servers:children]	#定义servers组，包含lbservers和webservers
lbservers
webservers
```

### 六、AD-Hoc
AD-Hoc类似单个的shell命令，执行完就结束。AD-Hoc命令格式如下：
命令格式|ansible|webservers|-m|command|-a|'df-h'
:-:|:-:|:-:|:-:|:-:|:-:|:-:
格式说明|命令|主机名称|指定模块|模块名称|模块动作|具体命令

使用AD-Hoc执行一次远程命令，注意观察返回结果的颜色
- 绿色：被管理端主机没有修改
- 黄色：被管理端主机发现变更
- 红色：故障
```diff
- 任何ansible模块的用法都可以通过ansible-doc命令查看示例语法
```
#### ping
```shell
# ansible all -m ping	#测试主机联通性
```

#### command & shell
对比：
	command模块不支持管道符号
	默认不指定-m模块时，使用command模块
```shell
# ansible web -m command -a 'ps -aux | grep nginx'

# ansible web -m shell -a 'ps -aux | grep nginx' 
```

#### yum
```shell
# ansible-doc yum	#查看EXAMPLES示例
```
